<html>
	<meta charset="UTF-8">
	<head>
		<title>skynet-node test script</title>
	</head>
	<body style="background-color:#CCCCCC"></body>

	<script>
// This is a testing file used to check that functions of the kernel are still
// working. It operates as a skapp and calls out to pieces of the kernel or
// pieces of kernel modules that are being adjusted.

// Open an iframe to the node.
var node = document.createElement("iframe");
node.src = "https://node.siasky.net";
node.style.width = "0";
node.style.height = "0";
node.style.border = "none";
node.style.position = "absolute";
document.body.appendChild(node);

var errors = 0;
var errorsDOM = document.createElement("p");
errorsDOM.innerHTML = errors.toString() + " errors";
errorsDOM.style.color = "green";
document.body.appendChild(errorsDOM);
function incrementErrors() {
	errors++;
	errorsDOM.innerHTML = errors.toString() + " errors";
	errorsDOM.style.color = "red";
}

// Set up a counter that establishes how many tests are supposed to pass.
var testsPassed = 0;
var expectedTestsPassed = 6;
var testsPassedDOM = document.createElement("p");
testsPassedDOM.innerHTML = testsPassed.toString() + " out of " + expectedTestsPassed.toString() + " tests passed";
testsPassedDOM.style.color = "blue";
document.body.appendChild(testsPassedDOM);
function incrementTestsPassed() {
	testsPassed++;
	testsPassedDOM.innerHTML = testsPassed.toString() + " out of " + expectedTestsPassed.toString() + " tests passed";
	if (testsPassed === expectedTestsPassed) {
		testsPassedDOM.style.color = "green";
	}
	if (testsPassed >  expectedTestsPassed) {
		testsPassedDOM.style.color = "red";
		incrementErrors();
	}

}

// appendMessage will append a simple message to the DOM, generally used to
// output the result of a test.
//
//  The error is optional, if set the message will be printed in red.
function appendMessage(message, error) {
	var p = document.createElement("p");
	p.innerHTML = message;

	if (error !== undefined) {
		p.style.color = "red";
	}
	document.body.appendChild(p);
}

// Create a listener that will receive messages and help conduct tests.
var nodeLoaded = false
window.addEventListener("message", (event) => {
	// Only receive messages from node.siasky.net.
	if (event.origin !== "https://node.siasky.net") {
		console.log("Rejecting postmessage request from ", event.origin);
		appendMessage("Got an unexpected message: " + event.origin);
		return;
	}
	// Log every message that comes in.
	console.log("Received message: " + event.data.kernelMethod, " :: ", performance.now());

	// Listen for the skynetNodeLoaded message.
	if (event.data.kernelMethod === "skynetNodeLoaded") {
		if (!nodeLoaded) {
			nodeLoaded = true;
			console.log("node loaded: ", performance.now());
			appendMessage("skynet node has loaded");
			incrementTestsPassed();
			// Send a message to trigger the next test: basic communication.
			node.contentWindow.postMessage({kernelMethod: "requestTest"}, "https://node.siasky.net");
		} else {
			appendMessage("received skynetNodeLoaded multiple times", true);
			incrementErrors();
		}
		return;
	}

	// Listen for the response from the test message.
	if (event.data.kernelMethod === "receiveTest") {
		appendMessage("receiveTest called");
		incrementTestsPassed();
		console.log("receiveTest completed: ", performance.now());

		// Send a message to trigger the next test: using a kernel
		// module. We've got an api call in a tester domain using the
		// method 'requestModification'.
		//
		// TODO: The default handler needs to be a portal-less skylink.
		node.contentWindow.postMessage({
			kernelMethod: "moduleCallV1",
			domain: "TODO", // TODO
			moduleMethod: "requestModification",
			workerInput: {
				testField: "test success"
			},
			requestNonce: 123,
			defaultHandler: "https://siasky.net/AACvEziMdRPtF-lac8Z76rNAbsyGqqR_8fzX2zjSJJj9Ug/"
		}, "https://node.siasky.net");
	}

	// Listen for the response from the test module call.
	//
	// TODO: The conditional should be checking the domain as well.
	if (event.data.kernelMethod === "moduleResponseV1" && event.data.moduleMethod === "requestModification") {
		console.log("moduleResponseV1 requestModification received :: ", performance.now())

		// Check that the request nonces are being handled correctly.
		if (event.data.requestNonce === 123) {
			appendMessage("moduleResponseV1 requestNonce is consistent");
			incrementTestsPassed();
		} else {
			console.log(event.data.requestNonce);
			appendMessage("moduleResponseV1 requestNonce is inconsistent", true);
			incrementErrors();
		}

		// Check that the result was received correctly.
		if (event.data.workerResponse.result === "test success.extended") {
			appendMessage("moduleResponseV1 workerResponse is consistent");
			incrementTestsPassed();
		} else {
			console.log(event.data.workerResponse);
			appendMessage("moduleResponseV1 workerResponse is inconsistent", true);
			incrementErrors();
		}

		// Send a message to trigger the next test: using a kernel
		// module that uses another kernel module. We will send
		// 'requestDoubleModification' to the basic comms module.
		//
		// TODO: The default handler needs to be a portal-less skylink.
		node.contentWindow.postMessage({
			kernelMethod: "moduleCallV1",
			domain: "TODO", // TODO
			moduleMethod: "requestDoubleModification",
			workerInput: {
				testField: "test success"
			},
			requestNonce: 121,
			defaultHandler: "https://siasky.net/AABep4CIflKMvS5TyrxiSh_V41Evm8RuFufnVEcAoYBk8A/"
		}, "https://node.siasky.net");
	}

	// Listen for the response from the test comms module call.
	//
	// TODO: The conditional should be checking the domain as well.
	if (event.data.kernelMethod === "moduleResponseV1" && event.data.moduleMethod === "requestDoubleModification") {
		console.log("moduleResponseV1 requestDoubleModification received :: ", performance.now())

		// Check that the request nonces are being handled correctly.
		if (event.data.requestNonce === 121) {
			appendMessage("moduleResponseV1 double modification requestNonce is consistent");
			incrementTestsPassed();
		} else {
			console.log(event.data.requestNonce);
			appendMessage("moduleResponseV1 double modification requestNonce is inconsistent", true);
			incrementErrors();
		}

		// Check that the result was received correctly.
		if (event.data.workerResponse !== undefined && event.data.workerResponse.result === "test success.double.extended") {
			appendMessage("moduleResponseV1 double modification workerResponse is consistent");
			incrementTestsPassed();
		} else {
			console.log(event.data.workerResponse);
			appendMessage("moduleResponseV1 double modification workerResponse is inconsistent", true);
			incrementErrors();
		}
	}

}, false);


	</script>
</html>
