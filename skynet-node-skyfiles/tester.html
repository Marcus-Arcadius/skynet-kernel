<html>
	<meta charset="UTF-8">
	<head>
		<title>skynet-node test script</title>
	</head>
	<body style="background-color:#CCCCCC"></body>

	<script>
// This is a testing file used to check that functions of the kernel are still
// working. It operates as a skapp and calls out to pieces of the kernel or
// pieces of kernel modules that are being adjusted.

// Open an iframe to the node.
var node = document.createElement("iframe");
node.src = "https://node.siasky.net";
node.style.width = "0";
node.style.height = "0";
node.style.border = "none";
node.style.position = "absolute";
document.body.appendChild(node);

var errors = 0;
var errorsDOM = document.createElement("p");
errorsDOM.innerHTML = errors.toString() + " errors";
errorsDOM.style.color = "green";
document.body.appendChild(errorsDOM);
function incrementErrors() {
	errors++;
	errorsDOM.innerHTML = errors.toString() + " errors";
	errorsDOM.style.color = "red";
}

// Set up a counter that establishes how many tests are supposed to pass.
var testsPassed = 0;
var expectedTestsPassed = 5;
var testsPassedDOM = document.createElement("p");
testsPassedDOM.innerHTML = testsPassed.toString() + " out of " + expectedTestsPassed.toString() + " tests passed";
testsPassedDOM.style.color = "blue";
document.body.appendChild(testsPassedDOM);
function incrementTestsPassed() {
	testsPassed++;
	testsPassedDOM.innerHTML = testsPassed.toString() + " out of " + expectedTestsPassed.toString() + " tests passed";
	if (testsPassed === expectedTestsPassed) {
		testsPassedDOM.style.color = "green";
	}
	if (testsPassed >  expectedTestsPassed) {
		testsPassedDOM.style.color = "red";
		incrementErrors();
	}

}

// appendMessage will append a simple message to the DOM, generally used to
// output the result of a test.
//
//  The error is optional, if set the message will be printed in red.
function appendMessage(message, error) {
	var p = document.createElement("p");
	p.innerHTML = message;

	if (error !== undefined) {
		p.style.color = "red";
	}
	document.body.appendChild(p);

	if (error) {
		console.log("appending error: " + message + " :: ", performance.now());
	} else {
		console.log("appending message: " + message + " :: ", performance.now());
	}
}

// This test ensures that the kernel is sending a message when startup
// completes.
var skynetNodeLoaded = false;
var handleSkynetNodeLoaded = function(event) {
	if (skynetNodeLoaded === false) {
		skynetNodeLoaded = true;
		appendMessage("skynet node has loaded");
		incrementTestsPassed();
	} else {
		appendMessage("received skynetNodeLoaded multiple times", true);
		incrementErrors();
	}
}

// This method is ensuring that the kernel's tester function is working. The
// tester function is used by devs to see that they are properly connected to
// the kernel.
var receivedTest = false;
var handleReceiveTest = function(event) {
	if (receivedTest === true) {
		appendMessage("received test multiple times", true);
		incrementErrors();
		return;
	}
	receivedTest = true;

	appendMessage("receiveTest called");
	incrementTestsPassed();
}

// This method checks that basic module communication is working.
var receivedResponse1 = false;
var handleReceiveModuleResponse1 = function(event) {
	if (receivedResponse1 === true) {
		appendMessage("received response1 multiple times");
		incrementErrors();
	}
	receivedRepsonse1 = true;

	// Check whether there was an error.
	if (event.data.kernelErr !== undefined) {
		appendMessage(event.data.kernelErr, true);
		incrementErrors();
		return;
	}

	// Check that the result was received correctly.
	if (event.data.moduleResponse !== undefined && event.data.moduleResponse.result === "test success.extended") {
		appendMessage("moduleResponseV1 moduleResponse is consistent");
		incrementTestsPassed();
	} else {
		console.log(event.data.moduleResponse);
		appendMessage("moduleResponseV1 moduleResponse is inconsistent", true);
		incrementErrors();
	}
}

// This method checks that the kernel retruns an error if no domain handler is
// provided.
var receivedResponseErr1 = false;
var handleReceiveModuleResponseErr1 = function(event) {
	if (receivedResponseErr1 === true) {
		appendMessage("received response1 multiple times");
		incrementErrors();
	}
	receivedRepsonseErr1 = true;

	// Check whether there was an error.
	if (event.data.kernelErr !== undefined) {
		appendMessage("moduleResponseV1 successfully errored when no domainHandler is provided");
		incrementTestsPassed();
		return;
	}

	// We were supposed to get an error, this was a bad request.
	appendMessage("expecting an error from the kernel, no error provided", true);
	incrementErrors();
}

// This method checks that cross-module-communication is working.
var receivedResponse2 = false;
var handleReceiveModuleResponse2 = function(event) {
	if (receivedResponse2 === true) {
		appendMessage("received response1 multiple times");
		incrementErrors();
	}
	receivedRepsonse2 = true;

	// Check whether there was an error.
	if (event.data.kernelErr !== undefined) {
		appendMessage(event.data.kernelErr, true);
		incrementErrors();
		return;
	}

	// Check that the result was received correctly.
	if (event.data.moduleResponse !== undefined && event.data.moduleResponse.result === "test success.double.extended") {
		appendMessage("moduleResponseV1 double modification moduleResponse is consistent");
		incrementTestsPassed();
	} else {
		console.log("double modification worker response is inconsistent");
		console.log(event.data.moduleResponse);
		appendMessage("moduleResponseV1 double modification moduleResponse is inconsistent", true);
		incrementErrors();
	}
}

// Create a listener that will receive messages and help conduct tests.
window.addEventListener("message", (event) => {
	// Only receive messages from node.siasky.net.
	if (event.origin !== "https://node.siasky.net") {
		console.log("Rejecting postmessage request from ", event.origin);
		appendMessage("Got an unexpected message: " + event.origin);
		return;
	}
	// Log every message that comes in.
	console.log("Tester received message: ", performance.now());
	console.log(event.data);

	// Listen for the skynetNodeLoaded message.
	if (event.data.kernelMethod === "skynetNodeLoaded") {
		handleSkynetNodeLoaded(event);

		// Send a message to trigger the next test: basic communication.
		node.contentWindow.postMessage({kernelMethod: "requestTest"}, "https://node.siasky.net");
		return;
	}

	// Listen for the response from the test message.
	if (event.data.kernelMethod === "receiveTest") {
		handleReceiveTest(event);

		// Send a message to trigger the next test: using a kernel
		// module.
		//
		// TODO: The default handler needs to be a portal-less skylink.
		node.contentWindow.postMessage({
			kernelMethod: "moduleCallV1",
			domain: "TODO", // TODO
			moduleMethod: "requestModification",
			moduleInput: {
				testField: "test success"
			},
			requestNonce: 0,
			defaultHandler: "https://siasky.net/AACq5NmB1mV3bB_GFznEK899l3Rt17WICuLWn8oVu3yu6Q/"
		}, "https://node.siasky.net");
		return;
	}

	if (event.data.kernelMethod === "moduleResponseV1" && event.data.requestNonce === 0) {
		handleReceiveModuleResponse1(event);

		// Send a message to trigger the next test: using a kernel
		// module with bad inputs - no domainHandler. This should
		// result in an error being returned.
		//
		// TODO: The default handler needs to be a portal-less skylink.
		node.contentWindow.postMessage({
			kernelMethod: "moduleCallV1",
			domain: "TODO", // TODO
			moduleMethod: "requestModification",
			moduleInput: {
				testField: "test success"
			},
			requestNonce: 1,
		}, "https://node.siasky.net");
		return;
	}

	// Listen for the response from the test module call.
	if (event.data.kernelMethod === "moduleResponseV1" && event.data.requestNonce === 1) {
		handleReceiveModuleResponseErr1(event);

		// Send a message to trigger the next test: using a kernel
		// module that uses another kernel module. We will send
		// 'requestDoubleModification' to the basic comms module.
		//
		// TODO: The default handler needs to be a portal-less skylink.
		node.contentWindow.postMessage({
			kernelMethod: "moduleCallV1",
			domain: "TODO", // TODO
			moduleMethod: "requestDoubleModification",
			moduleInput: {
				testField: "test success"
			},
			requestNonce: 2,
			defaultHandler: "https://siasky.net/AAAjnhyt07g_qP5I7qphAfp4HDrjg-zi80VnA9jjhHuQeA/"
		}, "https://node.siasky.net");
		return;
	}

	// Listen for the response from the test comms module call.
	if (event.data.kernelMethod === "moduleResponseV1" && event.data.requestNonce === 2) {
		handleReceiveModuleResponse2(event);
		return;
	}
}, false);

	</script>
</html>
