<!DOCTYPE html>
<html>
<body>
<h1>This is the Kernel Homepage for Logged in Users</h1>

<button onclick="requestLogOut()">Log Out</button>

<script>
// Build the function that will cause a logOut call.
function requestLogOut() {
	kernelFrame.contentWindow.postMessage({
		kernelMethod: "logOut",
		nonce: 1,
	}, "https://kernel.siasky.net")
}

// Add a quick handler to receive logging messages from the kernel.
window.addEventListener("message", (event) => {
	// Log about which message was received.
	console.log("received message\n", event.data)
	if (event.origin !== "https://kernel.siasky.net") {
		console.log("bad message received")
		return
	}

	// Handle a logout message. We ask the background script to do a
	// kernelTest because that will give the background script a chance to see
	// that the kernel is logged out.
	if (event.data.kernelMethod === "logOutSuccess") {
		console.log("calling reload")
		window.postMessage({
			method: "kernelQuery",
			nonce: 1,
			kernelQuery: {
				kernelMethod: "requestTest",
			}
		})
		setTimeout(location.reload, 1000)
	} else {
		console.log(event.data)
	}
}, false)

// Open the kernel in an invisible iframe. This is the only way to gain
// priviledged access to the kernel - any priviliedged pages must have a direct
// connection to the kernel so that the kernel can review their origin.
var kernelFrame = document.createElement("iframe")
kernelFrame.src = "https://kernel.siasky.net"
kernelFrame.style.width = "0"
kernelFrame.style.height = "0"
kernelFrame.style.border = "none"
kernelFrame.style.position = "absolute"
document.body.appendChild(kernelFrame)
</script>

</body>
</html>

